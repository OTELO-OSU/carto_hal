var app=angular.module("cartoHal",[]);app.controller("searchctrl",["$scope","$rootScope","$http",function($scope,$rootScope,$http){$scope.unique=function(array){return array.filter(function(el,index,arr){return index==arr.indexOf(el)})},$scope.search=function(){$scope.searchtoAPI(!1)},$scope.searchtoAPI=function(querydate,val){$("#countryinfo").hide(),$("#country").hide(),$("#map").hide(),$("#countryinfo").empty(),$rootScope.ConfigDefault.DisplayDatatable===!0?($("#loaderdatatable").show(),$("#datatablecontainer").show(),$("#mapcontainer").removeClass("centered")):($("#loaderdatatable").hide(),$("#datatablecontainer").hide(),$("#mapcontainer").addClass("centered")),$rootScope.ConfigDefault.DisplayMap===!0?($("#mapcontainer").show(),$("#loadermap").show(),$("#datatablecontainer").removeClass("centered")):($("#mapcontainer").hide(),$("#loadermap").hide(),$("#datatablecontainer").addClass("centered"));var url=$rootScope.ConfigDefault.ApiURL,resultSize=$rootScope.ConfigDefault.ResultSize;0==querydate?$http.get(url+"/search/"+$scope.query+"?fl=docid,instStructCountry_s,producedDateY_i&rows="+resultSize).then(function(response){$scope.docs=response.data.response.docs,years=[];for(doc in $scope.docs)year=$scope.docs[doc].producedDateY_i,years.push(year);$scope.minyear=Math.min.apply(null,years),$scope.maxyear=Math.max.apply(null,years),$(".range-slider").jRange({from:$scope.minyear,to:$scope.maxyear,step:1,format:"%s",width:300,showLabels:!0,isRange:!0,ondragend:function(val){$scope.searchtoAPI(!0,val)},onbarclicked:function(val){$scope.searchtoAPI(!0,val)}}),$(".range-slider").jRange("setValue",$scope.minyear+","+$scope.maxyear),$scope.parsingdata(response)}):(range=val.split(",",2),min=range[0],max=range[1],$http.get(url+"/search/"+$scope.query+"?fl=docid,instStructCountry_s&rows="+resultSize+"&fq=producedDateY_i:["+min+"%20TO%20"+max+"]").then(function(response){$scope.parsingdata(response)}))},$rootScope.ConfigDefault.query&&($scope.query=$rootScope.ConfigDefault.query,$scope.search()),$scope.parsingdata=function(response){var nocountrycode=0;$scope.docs=response.data.response.docs,$.getJSON("app/js/countries.json",function(json){bigarray=[];for(doc in $scope.docs)if(countrycodes=$scope.docs[doc].instStructCountry_s,countrycodes){countrycodes=countrycodes.map(function(x){return x.toUpperCase()}),countrycodes=$scope.unique(countrycodes);for(countrycode in countrycodes)array=[],countrycode=countrycodes[countrycode],countrycode=countrycode.toUpperCase(),array.push(countrycode),bigarray.push(array)}else nocountrycode+=1;arrayofcountrycode=[];for(countrycode in bigarray)$.each(bigarray[countrycode],function(key,value){arrayofcountrycode.push(value)});var counts={};arrayofcountrycode.forEach(function(x){counts[x]=(counts[x]||0)+1});var total=nocountrycode/response.data.response.numFound*100;total=100*total,total=Math.round(total),total/=100,$("#countryinfo").append("<h5>"+response.data.response.numFound+" records founds.</h5>"),$("#countryinfo").show(),0!=nocountrycode&&($("#countryinfo").empty(),$("#countryinfo").append("<h5>"+nocountrycode+" records of "+response.data.response.numFound+"  ("+total+"%) do not contain data in the field being analyzed.</h5>"),$("#countryinfo").show()),arrayrender=[],$.each(counts,function(countrycode,value){array=[],json.hasOwnProperty(countrycode)&&(lat=json[countrycode].coords[0],lon=json[countrycode].coords[1],countryname='<i class="'+countrycode.toLowerCase()+' flag"></i>'+json[countrycode].name,array.push(countryname),array.push(value),array.push(lat),array.push(lon),arrayrender.push(array))}),$rootScope.ConfigDefault.DisplayMap===!0&&$scope.rendering_on_map(arrayrender),$rootScope.ConfigDefault.DisplayDatatable===!0&&$scope.generate_datatable(arrayrender)})},$scope.rendering_on_map=function(arrayrender){"undefined"!=typeof mymap&&mymap.remove(),$("#map").show(),mymap=L.map("map").setView([51.505,-.09],4),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mymap);mymap.options.maxZoom = 5;var markers=[];base=4,coef=.6,div=4,$.each(arrayrender,function(key,value){if(occurence=value[1],1==occurence)var radius=base;else{var radius=occurence*coef;radius/=div}if(radius>40){var radius=occurence*coef;radius/=div}7>radius&&(radius=7),radius>100&&(radius=100),color="#"+Math.floor(16777215*Math.random()).toString(16);var circle=L.circleMarker([value[2],value[3]],{color:color,fillColor:color,fillOpacity:.5,radius:radius});circle.bindPopup("Country: "+value[0]+"<br>Number of publications: "+value[1]),circle.on("mouseover",function(e){this.openPopup()}),circle.on("mouseout",function(e){this.closePopup()}),circle.bindTooltip("<b>"+value[1]+"</b>",{noHide:!0,permanent:!0,direction:"center"}).openTooltip(),markers.push(circle)}),"undefined"!=typeof group&&mymap.removeLayer(group),group=L.featureGroup(markers),group.addTo(mymap),bounds=group.getBounds(),mymap.invalidateSize(),mymap.fitBounds(bounds),$(".print").off("click"),$(".print").on("click",function(){$.print("#map",{title:"Map of publications per country for collection : "+$scope.query})}),$("#loadermap").hide(),$("#mapaspdf").show()},$scope.generate_datatable=function(arrayrender){$("#country").show();var table=$("#country").DataTable({data:arrayrender,lengthChange:!1,destroy:!0,pageLength:5,order:[[1,"desc"]],pagingType:"numbers",responsive:!0,dom:"frtip",autoWidth:!1});new $.fn.dataTable.Buttons(table,{buttons:[{extend:"csvHtml5",text:"Export CSV",title:$scope.query+"_country",className:"ui primary button"}]}).container().appendTo($("#buttons_country"));$("#loaderdatatable").hide()}}]),app.directive("search",function(){return{templateUrl:"app/templates/search.html",controller:"searchctrl"}}),app.run(["$rootScope",function($rootScope){$rootScope.ConfigDefault={ApiURL:"http://api.archives-ouvertes.fr",DisplayMap:!0,DisplayDatatable:!0,ResultSize:1e4},window.ConfigWidgetHal&&Object.getOwnPropertyNames(window.ConfigWidgetHal).length>0&&($rootScope.ConfigDefault=$.extend($rootScope.ConfigDefault,window.ConfigWidgetHal))}]);